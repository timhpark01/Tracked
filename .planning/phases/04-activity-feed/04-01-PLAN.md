---
phase: 04-activity-feed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/feed/services/feed.service.ts
  - src/features/feed/hooks/useFeed.ts
  - src/features/feed/index.ts
  - src/features/logs/hooks/useCreateLog.ts
autonomous: true

must_haves:
  truths:
    - "Feed service fetches logs from followed users only (RLS enforced)"
    - "useFeed hook provides paginated data with hasNextPage/fetchNextPage"
    - "Creating a new log invalidates the feed cache"
  artifacts:
    - path: "src/features/feed/services/feed.service.ts"
      provides: "getFeedLogs function with joins"
      exports: ["getFeedLogs", "FeedLog"]
    - path: "src/features/feed/hooks/useFeed.ts"
      provides: "useInfiniteQuery wrapper for feed"
      exports: ["useFeed"]
    - path: "src/features/feed/index.ts"
      provides: "Public exports for feed feature"
      exports: ["useFeed", "getFeedLogs", "FeedLog"]
  key_links:
    - from: "src/features/feed/hooks/useFeed.ts"
      to: "src/features/feed/services/feed.service.ts"
      via: "import getFeedLogs"
      pattern: "import.*getFeedLogs.*from.*feed\\.service"
    - from: "src/features/logs/hooks/useCreateLog.ts"
      to: "queryClient.invalidateQueries"
      via: "feed invalidation on success"
      pattern: "invalidateQueries.*feed"
---

<objective>
Create the feed data layer with service and hook for paginated activity feed

Purpose: Provides the data fetching infrastructure for the activity feed, enabling users to see followed users' logs with infinite scroll pagination. This establishes the service and hook pattern that UI components will consume.

Output:
- Feed service with getFeedLogs(start, end) function
- useFeed hook using useInfiniteQuery
- Feed cache invalidation when user creates new log
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-activity-feed/04-RESEARCH.md

# Existing patterns to follow
@src/features/social/services/social.service.ts
@src/features/social/hooks/useSearchUsers.ts
@src/features/logs/hooks/useCreateLog.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feed service with paginated query</name>
  <files>src/features/feed/services/feed.service.ts</files>
  <action>
Create feed service following existing service patterns:

1. Define FeedLog type with nested user and hobby data:
   ```typescript
   export type FeedLog = {
     id: string
     value: number
     note: string | null
     image_urls: string[] | null
     logged_at: string
     user: {
       id: string
       username: string
       avatar_url: string | null
     }
     hobby: {
       id: string
       name: string
       tracking_type: 'time' | 'quantity'
       goal_unit: string | null
     }
   }
   ```

2. Create getFeedLogs function:
   - Parameters: start (number), end (number) - range indices
   - Query hobby_logs with nested select for profiles and hobbies
   - Use relationship aliases: `user:profiles!hobby_logs_user_id_fkey` and `hobby:hobbies!hobby_logs_hobby_id_fkey`
   - Order by logged_at DESC, then id DESC for stable sort (prevents duplicates across pages)
   - Use .range(start, end) for pagination
   - RLS policy "Followers can view logs" automatically filters to followed users
   - Return type assertion as FeedLog[] (Supabase nested types need cast)

Reference research patterns in 04-RESEARCH.md (lines 297-357).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
getFeedLogs function exists, accepts start/end params, returns Promise of FeedLog[] with nested user/hobby data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useFeed hook with infinite query</name>
  <files>src/features/feed/hooks/useFeed.ts, src/features/feed/index.ts</files>
  <action>
Create useFeed hook following existing hook patterns:

1. In src/features/feed/hooks/useFeed.ts:
   - Import useInfiniteQuery from @tanstack/react-query
   - Import getFeedLogs from ../services/feed.service
   - Define PAGE_SIZE = 20 constant
   - Create useFeed function using useInfiniteQuery:
     - queryKey: ['feed']
     - queryFn: Calculate start = pageParam * PAGE_SIZE, end = start + PAGE_SIZE - 1, call getFeedLogs(start, end)
     - initialPageParam: 0
     - getNextPageParam: Return undefined if lastPage.length < PAGE_SIZE (no more pages), otherwise return lastPageParam + 1
     - staleTime: 2 * 60 * 1000 (2 minutes - feeds change frequently)
     - gcTime: 24 * 60 * 60 * 1000 (24 hours - mobile optimized, matches existing pattern)

2. Create src/features/feed/index.ts:
   - Export useFeed from './hooks/useFeed'
   - Export FeedLog type and getFeedLogs from './services/feed.service'

Reference research patterns in 04-RESEARCH.md (lines 360-386).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useFeed hook exists, uses useInfiniteQuery, exports available from @/features/feed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add feed cache invalidation to useCreateLog</name>
  <files>src/features/logs/hooks/useCreateLog.ts</files>
  <action>
Modify existing useCreateLog hook to invalidate feed cache:

1. Read current useCreateLog.ts implementation
2. In the onSuccess callback, add invalidation for feed query:
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['feed'] })
   ```
3. Keep existing invalidations (logs, hobbyStats) - this is additive

This ensures when user creates a new log, their followers' feeds will refresh to show it.

Reference research pattern in 04-RESEARCH.md (lines 200-219).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Check file contains both existing invalidations AND new feed invalidation
  </verify>
  <done>
useCreateLog.ts invalidates ['feed'] query in addition to existing invalidations
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Feed feature exports are available: Check src/features/feed/index.ts exports useFeed, FeedLog, getFeedLogs
3. Feed query uses correct patterns: Verify useInfiniteQuery setup matches TanStack Query v5 API
</verification>

<success_criteria>
- getFeedLogs function fetches hobby_logs with nested user/hobby data using range pagination
- useFeed hook wraps getFeedLogs in useInfiniteQuery with PAGE_SIZE=20
- Creating a log invalidates the feed cache
- All code follows existing codebase conventions (service layer, hook patterns, TypeScript)
</success_criteria>

<output>
After completion, create `.planning/phases/04-activity-feed/04-01-SUMMARY.md`
</output>
