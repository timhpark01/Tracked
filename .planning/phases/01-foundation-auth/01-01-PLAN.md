---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app.json
  - tsconfig.json
  - app/_layout.tsx
  - app/index.tsx
  - src/lib/.gitkeep
  - src/features/.gitkeep
  - src/components/.gitkeep
  - src/types/.gitkeep
  - supabase/migrations/00001_create_schema.sql
  - .env.local
  - .env.example
autonomous: false

user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: EXPO_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: EXPO_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    account_setup:
      - task: "Create Supabase account"
        url: "https://supabase.com"
      - task: "Create new Supabase project"
        location: "Supabase Dashboard -> New Project"

must_haves:
  truths:
    - "Expo project runs with npx expo start"
    - "Database has profiles, hobbies, hobby_logs, follows tables"
    - "RLS is enabled on all tables"
    - "Indexes exist on all RLS policy columns"
  artifacts:
    - path: "package.json"
      provides: "Expo project dependencies"
      contains: "expo"
    - path: "supabase/migrations/00001_create_schema.sql"
      provides: "Database schema with RLS"
      contains: "ENABLE ROW LEVEL SECURITY"
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "EXPO_PUBLIC_SUPABASE_URL"
  key_links:
    - from: "supabase/migrations/00001_create_schema.sql"
      to: "Supabase project"
      via: "supabase db push"
      pattern: "CREATE TABLE"
---

<objective>
Initialize Expo project with TypeScript and create complete database schema with RLS.

Purpose: Establishes the foundational infrastructure - a working Expo project and secure database schema that all subsequent features depend on.
Output: Running Expo app skeleton and deployed database with profiles, hobbies, hobby_logs, follows tables.
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Expo project with TypeScript</name>
  <files>
    package.json
    app.json
    tsconfig.json
    app/_layout.tsx
    app/index.tsx
    src/lib/.gitkeep
    src/features/.gitkeep
    src/components/.gitkeep
    src/types/.gitkeep
    .env.example
  </files>
  <action>
Create Expo project using `npx create-expo-app@latest Tracked --template blank-typescript` in the project root's parent directory, then move contents into current directory (or init in place if directory is empty except .planning).

After project creation:

1. Create directory structure:
   - src/lib/ (for supabase.ts, query-client.ts)
   - src/features/ (for feature modules like auth/)
   - src/components/ (for shared components)
   - src/types/ (for TypeScript types)
   Add .gitkeep files to empty directories.

2. Install dependencies:
   ```bash
   npx expo install @supabase/supabase-js @react-native-async-storage/async-storage react-native-url-polyfill expo-sqlite
   npm install @tanstack/react-query
   npx expo install @react-native-community/netinfo
   ```

3. Create .env.example with placeholder variables:
   ```
   EXPO_PUBLIC_SUPABASE_URL=your_supabase_url
   EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
   ```

4. Add .env.local to .gitignore if not already present.

5. Update app/_layout.tsx to be a minimal root layout with Slot.

Note: Do NOT configure Supabase client or QueryClient yet - that's Plan 01-02.
  </action>
  <verify>
    - `npx expo start` launches without errors
    - src/lib/, src/features/, src/components/, src/types/ directories exist
    - .env.example contains EXPO_PUBLIC_SUPABASE_URL and EXPO_PUBLIC_SUPABASE_ANON_KEY
    - package.json contains @supabase/supabase-js, @tanstack/react-query, @react-native-community/netinfo
  </verify>
  <done>
    Expo project runs successfully, directory structure matches research recommendations, all dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema with RLS</name>
  <files>
    supabase/migrations/00001_create_schema.sql
  </files>
  <action>
Initialize Supabase CLI in project:
```bash
supabase init
```

Create migration file `supabase/migrations/00001_create_schema.sql` with complete schema:

**profiles table:**
- id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
- username TEXT UNIQUE NOT NULL
- avatar_url TEXT
- bio TEXT
- is_public BOOLEAN DEFAULT true
- created_at TIMESTAMPTZ DEFAULT NOW()

**hobbies table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
- name TEXT NOT NULL
- description TEXT
- category TEXT
- tracking_type TEXT NOT NULL CHECK (tracking_type IN ('time', 'quantity'))
- goal_total INTEGER
- goal_unit TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()

**hobby_logs table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- hobby_id UUID NOT NULL REFERENCES hobbies(id) ON DELETE CASCADE
- user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
- value INTEGER NOT NULL (minutes or quantity units)
- note TEXT
- image_urls TEXT[]
- logged_at TIMESTAMPTZ DEFAULT NOW()
- created_at TIMESTAMPTZ DEFAULT NOW()
- metadata JSONB DEFAULT '{}'::jsonb

**follows table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- follower_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
- following_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(follower_id, following_id)
- CHECK (follower_id != following_id)

**For each table, IMMEDIATELY after CREATE TABLE:**
1. `ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;`
2. Create indexes on ALL columns used in RLS policies

**RLS Policies (per RESEARCH.md and PRIV-01):**

profiles:
- SELECT: Anyone can view public profiles (is_public = true)
- SELECT: Users can view own profile (auth.uid() = id)
- UPDATE: Users can update own profile (auth.uid() = id)
- INSERT: Users can insert own profile (auth.uid() = id)

hobbies:
- SELECT: Users can view own hobbies (auth.uid() = user_id)
- SELECT: Anyone can view hobbies of public profiles
- INSERT/UPDATE/DELETE: Users can modify own hobbies (auth.uid() = user_id)

hobby_logs:
- SELECT: Users can view own logs (auth.uid() = user_id)
- SELECT: Followers can view logs (owner is public OR viewer follows owner)
- INSERT/UPDATE/DELETE: Users can modify own logs (auth.uid() = user_id)

follows:
- SELECT: Users can view own follows and followers
- SELECT: Anyone can view follows of public profiles
- INSERT: Users can follow (auth.uid() = follower_id)
- DELETE: Users can unfollow (auth.uid() = follower_id)

**Critical:** Wrap auth.uid() in (SELECT auth.uid()) for performance per research.

Also create a database trigger to auto-create profile on user signup:
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username)
  VALUES (NEW.id, NEW.email);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```
  </action>
  <verify>
    - supabase/migrations/00001_create_schema.sql exists and contains all 4 tables
    - Each table has ENABLE ROW LEVEL SECURITY
    - Indexes exist for id, user_id, follower_id, following_id columns
    - RLS policies exist for each table
    - Profile auto-creation trigger exists
  </verify>
  <done>
    Database migration file complete with all tables, RLS enabled, indexes created, policies defined, and profile trigger ready.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Expo project initialized with all dependencies and database migration ready to deploy.
  </what-built>
  <how-to-verify>
    1. Create a Supabase project at https://supabase.com (if not already done)
    2. Copy Project URL and anon key from Supabase Dashboard -> Project Settings -> API
    3. Create .env.local file with:
       ```
       EXPO_PUBLIC_SUPABASE_URL=your_url_here
       EXPO_PUBLIC_SUPABASE_ANON_KEY=your_key_here
       ```
    4. Link Supabase CLI to your project:
       ```bash
       supabase login
       supabase link --project-ref YOUR_PROJECT_REF
       ```
    5. Push migration to Supabase:
       ```bash
       supabase db push
       ```
    6. Verify in Supabase Dashboard -> Table Editor that all 4 tables exist
    7. Verify in Supabase Dashboard -> Authentication -> Policies that RLS policies exist
    8. Run `npx expo start` and confirm app loads
  </how-to-verify>
  <resume-signal>Type "approved" after completing Supabase setup and verifying tables exist, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- [ ] `npx expo start` runs without errors
- [ ] package.json contains all required dependencies
- [ ] src/ directory structure matches plan
- [ ] supabase/migrations/00001_create_schema.sql contains all 4 tables
- [ ] All tables have RLS enabled (verify in Supabase Dashboard)
- [ ] .env.local created with real Supabase credentials
</verification>

<success_criteria>
1. Expo project starts successfully
2. All 4 database tables exist in Supabase with RLS enabled
3. Indexes exist on all RLS policy columns
4. Profile auto-creation trigger is active
5. .env.local contains valid Supabase credentials
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
