---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/supabase.ts
  - src/lib/query-client.ts
  - src/features/auth/services/auth.service.ts
  - src/features/auth/hooks/useAuth.ts
  - src/types/database.ts
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Supabase client connects to remote project"
    - "Session persists across app restarts"
    - "TanStack Query refetches on app foreground"
    - "Auth state changes trigger re-renders"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Configured Supabase client"
      contains: "createClient"
    - path: "src/lib/query-client.ts"
      provides: "TanStack Query configuration"
      contains: "QueryClient"
    - path: "src/features/auth/hooks/useAuth.ts"
      provides: "Auth state hook"
      exports: ["useAuth"]
    - path: "src/features/auth/services/auth.service.ts"
      provides: "Auth operations"
      exports: ["signUp", "signIn", "signOut"]
  key_links:
    - from: "src/lib/supabase.ts"
      to: ".env.local"
      via: "process.env"
      pattern: "EXPO_PUBLIC_SUPABASE"
    - from: "src/features/auth/hooks/useAuth.ts"
      to: "src/lib/supabase.ts"
      via: "import"
      pattern: "supabase\\.auth"
    - from: "app/_layout.tsx"
      to: "src/lib/query-client.ts"
      via: "QueryClientProvider"
      pattern: "QueryClientProvider"
---

<objective>
Configure Supabase client with session persistence and TanStack Query with React Native managers, then create auth hooks and services.

Purpose: Establishes the data layer infrastructure - Supabase client for backend communication and TanStack Query for state management. Auth hooks enable all subsequent auth-dependent features.
Output: Working Supabase client, configured QueryClient, and reusable auth hooks (useAuth) and services (signUp, signIn, signOut).
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Supabase client with session persistence</name>
  <files>
    src/lib/supabase.ts
    src/types/database.ts
  </files>
  <action>
Create `src/lib/supabase.ts` following the pattern from RESEARCH.md:

```typescript
// src/lib/supabase.ts
import 'react-native-url-polyfill/auto'
import 'expo-sqlite/localStorage/install'
import { AppState, Platform } from 'react-native'
import AsyncStorage from '@react-native-async-storage/async-storage'
import { createClient, processLock } from '@supabase/supabase-js'
import type { Database } from '@/types/database'

const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    ...(Platform.OS !== 'web' ? { storage: AsyncStorage } : {}),
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
    lock: processLock,
  },
})

// Auto-refresh on app state changes (React Native only)
if (Platform.OS !== 'web') {
  AppState.addEventListener('change', (state) => {
    if (state === 'active') {
      supabase.auth.startAutoRefresh()
    } else {
      supabase.auth.stopAutoRefresh()
    }
  })
}
```

Create `src/types/database.ts` with Database type placeholder (can be generated from Supabase later):

```typescript
// src/types/database.ts
export type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]

export interface Database {
  public: {
    Tables: {
      profiles: {
        Row: {
          id: string
          username: string
          avatar_url: string | null
          bio: string | null
          is_public: boolean
          created_at: string
        }
        Insert: {
          id: string
          username: string
          avatar_url?: string | null
          bio?: string | null
          is_public?: boolean
          created_at?: string
        }
        Update: {
          id?: string
          username?: string
          avatar_url?: string | null
          bio?: string | null
          is_public?: boolean
          created_at?: string
        }
      }
      hobbies: {
        Row: {
          id: string
          user_id: string
          name: string
          description: string | null
          category: string | null
          tracking_type: 'time' | 'quantity'
          goal_total: number | null
          goal_unit: string | null
          created_at: string
        }
        Insert: {
          id?: string
          user_id: string
          name: string
          description?: string | null
          category?: string | null
          tracking_type: 'time' | 'quantity'
          goal_total?: number | null
          goal_unit?: string | null
          created_at?: string
        }
        Update: {
          id?: string
          user_id?: string
          name?: string
          description?: string | null
          category?: string | null
          tracking_type?: 'time' | 'quantity'
          goal_total?: number | null
          goal_unit?: string | null
          created_at?: string
        }
      }
      hobby_logs: {
        Row: {
          id: string
          hobby_id: string
          user_id: string
          value: number
          note: string | null
          image_urls: string[] | null
          logged_at: string
          created_at: string
          metadata: Json
        }
        Insert: {
          id?: string
          hobby_id: string
          user_id: string
          value: number
          note?: string | null
          image_urls?: string[] | null
          logged_at?: string
          created_at?: string
          metadata?: Json
        }
        Update: {
          id?: string
          hobby_id?: string
          user_id?: string
          value?: number
          note?: string | null
          image_urls?: string[] | null
          logged_at?: string
          created_at?: string
          metadata?: Json
        }
      }
      follows: {
        Row: {
          id: string
          follower_id: string
          following_id: string
          created_at: string
        }
        Insert: {
          id?: string
          follower_id: string
          following_id: string
          created_at?: string
        }
        Update: {
          id?: string
          follower_id?: string
          following_id?: string
          created_at?: string
        }
      }
    }
  }
}
```

Also configure path alias in tsconfig.json if not present:
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}
```
  </action>
  <verify>
    - src/lib/supabase.ts exists with createClient call
    - src/types/database.ts exists with Database interface
    - TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
    Supabase client configured with AsyncStorage for session persistence, typed with Database interface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure TanStack Query for React Native</name>
  <files>
    src/lib/query-client.ts
    app/_layout.tsx
  </files>
  <action>
Create `src/lib/query-client.ts` following RESEARCH.md pattern:

```typescript
// src/lib/query-client.ts
import { useEffect } from 'react'
import { AppState, Platform } from 'react-native'
import type { AppStateStatus } from 'react-native'
import NetInfo from '@react-native-community/netinfo'
import { QueryClient, focusManager, onlineManager } from '@tanstack/react-query'

// Configure online status detection
onlineManager.setEventListener((setOnline) => {
  return NetInfo.addEventListener((state) => {
    setOnline(!!state.isConnected)
  })
})

// Configure focus detection for app state changes
function onAppStateChange(status: AppStateStatus) {
  if (Platform.OS !== 'web') {
    focusManager.setFocused(status === 'active')
  }
}

// Hook to initialize app state listener
export function useAppStateRefresh() {
  useEffect(() => {
    const subscription = AppState.addEventListener('change', onAppStateChange)
    return () => subscription.remove()
  }, [])
}

// QueryClient with mobile-optimized defaults
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      gcTime: 1000 * 60 * 60 * 24,   // 24 hours
      staleTime: 1000 * 60 * 5,       // 5 minutes
      retry: 2,
      networkMode: 'always',
      refetchOnWindowFocus: true,
    },
    mutations: {
      networkMode: 'always',
    },
  },
})
```

Update `app/_layout.tsx` to wrap app in QueryClientProvider:

```typescript
// app/_layout.tsx
import { Slot } from 'expo-router'
import { QueryClientProvider } from '@tanstack/react-query'
import { queryClient, useAppStateRefresh } from '@/lib/query-client'

export default function RootLayout() {
  useAppStateRefresh()

  return (
    <QueryClientProvider client={queryClient}>
      <Slot />
    </QueryClientProvider>
  )
}
```
  </action>
  <verify>
    - src/lib/query-client.ts exists with QueryClient export
    - app/_layout.tsx imports and uses QueryClientProvider
    - `npx expo start` runs without errors
  </verify>
  <done>
    TanStack Query configured with React Native managers for online/focus detection, app wrapped in QueryClientProvider.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create auth hooks and services</name>
  <files>
    src/features/auth/services/auth.service.ts
    src/features/auth/hooks/useAuth.ts
    src/features/auth/index.ts
  </files>
  <action>
Create auth service with signUp, signIn, signOut:

```typescript
// src/features/auth/services/auth.service.ts
import { supabase } from '@/lib/supabase'

export async function signUp(email: string, password: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
  })

  if (error) throw error

  // Check if email confirmation is required
  if (!data.session) {
    return { requiresConfirmation: true, user: data.user }
  }

  return { session: data.session, user: data.user }
}

export async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) throw error
  return { session: data.session, user: data.user }
}

export async function signOut() {
  const { error } = await supabase.auth.signOut()
  if (error) throw error
}
```

Create useAuth hook for auth state:

```typescript
// src/features/auth/hooks/useAuth.ts
import { useEffect, useState } from 'react'
import { Session, User } from '@supabase/supabase-js'
import { supabase } from '@/lib/supabase'

export function useAuth() {
  const [session, setSession] = useState<Session | null>(null)
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setUser(session?.user ?? null)
      setLoading(false)
    })

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session)
        setUser(session?.user ?? null)
      }
    )

    return () => subscription.unsubscribe()
  }, [])

  return { session, user, loading }
}
```

Create barrel export:

```typescript
// src/features/auth/index.ts
export { useAuth } from './hooks/useAuth'
export { signUp, signIn, signOut } from './services/auth.service'
```
  </action>
  <verify>
    - src/features/auth/services/auth.service.ts exports signUp, signIn, signOut
    - src/features/auth/hooks/useAuth.ts exports useAuth
    - src/features/auth/index.ts re-exports all
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    Auth infrastructure complete with hooks (useAuth) and services (signUp, signIn, signOut) ready for use in screens.
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npx expo start` runs without errors
- [ ] src/lib/supabase.ts creates typed Supabase client
- [ ] src/lib/query-client.ts exports queryClient and useAppStateRefresh
- [ ] app/_layout.tsx wraps app in QueryClientProvider
- [ ] src/features/auth/ contains hooks and services
</verification>

<success_criteria>
1. Supabase client connects (verify by testing a simple query in dev tools)
2. TanStack Query is configured and wraps the app
3. useAuth hook returns session, user, loading state
4. signUp, signIn, signOut functions are implemented and typed
5. All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
