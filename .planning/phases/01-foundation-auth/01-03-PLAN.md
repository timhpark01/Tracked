---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/(auth)/_layout.tsx
  - app/(auth)/login.tsx
  - app/(auth)/signup.tsx
  - app/(app)/_layout.tsx
  - app/(app)/index.tsx
  - app/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can create account with email and password"
    - "User can log in with existing credentials"
    - "User can log out from any screen"
    - "Session persists across app restarts"
    - "Unauthenticated users are redirected to login"
    - "Authenticated users are redirected to app"
  artifacts:
    - path: "app/(auth)/login.tsx"
      provides: "Login screen UI"
      contains: "signIn"
    - path: "app/(auth)/signup.tsx"
      provides: "Signup screen UI"
      contains: "signUp"
    - path: "app/(app)/_layout.tsx"
      provides: "Protected route guard"
      contains: "Redirect"
    - path: "app/(auth)/_layout.tsx"
      provides: "Public route guard"
      contains: "Redirect"
  key_links:
    - from: "app/(auth)/login.tsx"
      to: "src/features/auth/services/auth.service.ts"
      via: "signIn import"
      pattern: "signIn"
    - from: "app/(app)/_layout.tsx"
      to: "src/features/auth/hooks/useAuth.ts"
      via: "useAuth import"
      pattern: "useAuth"
    - from: "app/(auth)/_layout.tsx"
      to: "/(app)"
      via: "Redirect on session"
      pattern: "Redirect.*app"
---

<objective>
Create login and signup screens with protected route layouts using Expo Router.

Purpose: Delivers the user-facing auth experience - signup, login, and logout functionality with proper route protection. This completes the auth requirements (AUTH-01 through AUTH-04).
Output: Working login/signup screens and protected route structure that redirects based on auth state.
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth screens (login and signup)</name>
  <files>
    app/(auth)/_layout.tsx
    app/(auth)/login.tsx
    app/(auth)/signup.tsx
  </files>
  <action>
Create the (auth) route group for public auth screens.

**app/(auth)/_layout.tsx** - Public auth layout that redirects to app if already authenticated:

```typescript
import { Redirect, Stack } from 'expo-router'
import { useAuth } from '@/features/auth'

export default function AuthLayout() {
  const { session, loading } = useAuth()

  // Show nothing while loading (prevents flash)
  if (loading) {
    return null
  }

  // Redirect to app if already authenticated
  if (session) {
    return <Redirect href="/(app)" />
  }

  return (
    <Stack screenOptions={{ headerShown: false }}>
      <Stack.Screen name="login" />
      <Stack.Screen name="signup" />
    </Stack>
  )
}
```

**app/(auth)/login.tsx** - Login screen with email/password form:

```typescript
import { useState } from 'react'
import { View, Text, TextInput, TouchableOpacity, StyleSheet, Alert, ActivityIndicator } from 'react-native'
import { Link, router } from 'expo-router'
import { signIn } from '@/features/auth'

export default function LoginScreen() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)

  const handleLogin = async () => {
    if (!email || !password) {
      Alert.alert('Error', 'Please fill in all fields')
      return
    }

    setLoading(true)
    try {
      await signIn(email, password)
      router.replace('/(app)')
    } catch (error: any) {
      Alert.alert('Login Failed', error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Welcome Back</Text>
      <Text style={styles.subtitle}>Sign in to continue tracking</Text>

      <TextInput
        style={styles.input}
        placeholder="Email"
        value={email}
        onChangeText={setEmail}
        autoCapitalize="none"
        keyboardType="email-address"
        editable={!loading}
      />

      <TextInput
        style={styles.input}
        placeholder="Password"
        value={password}
        onChangeText={setPassword}
        secureTextEntry
        editable={!loading}
      />

      <TouchableOpacity
        style={[styles.button, loading && styles.buttonDisabled]}
        onPress={handleLogin}
        disabled={loading}
      >
        {loading ? (
          <ActivityIndicator color="#fff" />
        ) : (
          <Text style={styles.buttonText}>Sign In</Text>
        )}
      </TouchableOpacity>

      <Link href="/(auth)/signup" asChild>
        <TouchableOpacity style={styles.linkButton}>
          <Text style={styles.linkText}>Don't have an account? Sign up</Text>
        </TouchableOpacity>
      </Link>
    </View>
  )
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 24,
    justifyContent: 'center',
    backgroundColor: '#fff',
  },
  title: {
    fontSize: 32,
    fontWeight: 'bold',
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 16,
    color: '#666',
    marginBottom: 32,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    fontSize: 16,
  },
  button: {
    backgroundColor: '#007AFF',
    padding: 16,
    borderRadius: 8,
    alignItems: 'center',
    marginTop: 8,
  },
  buttonDisabled: {
    opacity: 0.7,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  linkButton: {
    marginTop: 24,
    alignItems: 'center',
  },
  linkText: {
    color: '#007AFF',
    fontSize: 14,
  },
})
```

**app/(auth)/signup.tsx** - Signup screen with email/password form:

```typescript
import { useState } from 'react'
import { View, Text, TextInput, TouchableOpacity, StyleSheet, Alert, ActivityIndicator } from 'react-native'
import { Link, router } from 'expo-router'
import { signUp } from '@/features/auth'

export default function SignupScreen() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSignup = async () => {
    if (!email || !password || !confirmPassword) {
      Alert.alert('Error', 'Please fill in all fields')
      return
    }

    if (password !== confirmPassword) {
      Alert.alert('Error', 'Passwords do not match')
      return
    }

    if (password.length < 6) {
      Alert.alert('Error', 'Password must be at least 6 characters')
      return
    }

    setLoading(true)
    try {
      const result = await signUp(email, password)
      if (result.requiresConfirmation) {
        Alert.alert(
          'Check Your Email',
          'We sent you a confirmation link. Please check your email.',
          [{ text: 'OK', onPress: () => router.replace('/(auth)/login') }]
        )
      } else {
        router.replace('/(app)')
      }
    } catch (error: any) {
      Alert.alert('Signup Failed', error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Create Account</Text>
      <Text style={styles.subtitle}>Start tracking your progress</Text>

      <TextInput
        style={styles.input}
        placeholder="Email"
        value={email}
        onChangeText={setEmail}
        autoCapitalize="none"
        keyboardType="email-address"
        editable={!loading}
      />

      <TextInput
        style={styles.input}
        placeholder="Password"
        value={password}
        onChangeText={setPassword}
        secureTextEntry
        editable={!loading}
      />

      <TextInput
        style={styles.input}
        placeholder="Confirm Password"
        value={confirmPassword}
        onChangeText={setConfirmPassword}
        secureTextEntry
        editable={!loading}
      />

      <TouchableOpacity
        style={[styles.button, loading && styles.buttonDisabled]}
        onPress={handleSignup}
        disabled={loading}
      >
        {loading ? (
          <ActivityIndicator color="#fff" />
        ) : (
          <Text style={styles.buttonText}>Create Account</Text>
        )}
      </TouchableOpacity>

      <Link href="/(auth)/login" asChild>
        <TouchableOpacity style={styles.linkButton}>
          <Text style={styles.linkText}>Already have an account? Sign in</Text>
        </TouchableOpacity>
      </Link>
    </View>
  )
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 24,
    justifyContent: 'center',
    backgroundColor: '#fff',
  },
  title: {
    fontSize: 32,
    fontWeight: 'bold',
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 16,
    color: '#666',
    marginBottom: 32,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    fontSize: 16,
  },
  button: {
    backgroundColor: '#007AFF',
    padding: 16,
    borderRadius: 8,
    alignItems: 'center',
    marginTop: 8,
  },
  buttonDisabled: {
    opacity: 0.7,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  linkButton: {
    marginTop: 24,
    alignItems: 'center',
  },
  linkText: {
    color: '#007AFF',
    fontSize: 14,
  },
})
```

Note: Styles are inline React Native StyleSheet for now. NativeWind styling will be added in Phase 2 when building actual features.
  </action>
  <verify>
    - app/(auth)/_layout.tsx exists and redirects authenticated users
    - app/(auth)/login.tsx renders login form
    - app/(auth)/signup.tsx renders signup form
    - `npx expo start` shows login screen when not authenticated
  </verify>
  <done>
    Auth screens implemented with email/password forms, loading states, error handling, and navigation between login/signup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement protected route layouts with logout</name>
  <files>
    app/(app)/_layout.tsx
    app/(app)/index.tsx
    app/index.tsx
  </files>
  <action>
Create the (app) route group for protected screens.

**app/(app)/_layout.tsx** - Protected layout that redirects unauthenticated users:

```typescript
import { Redirect, Stack } from 'expo-router'
import { View, ActivityIndicator, StyleSheet } from 'react-native'
import { useAuth } from '@/features/auth'

export default function AppLayout() {
  const { session, loading } = useAuth()

  // Show loading screen while checking session
  if (loading) {
    return (
      <View style={styles.loading}>
        <ActivityIndicator size="large" color="#007AFF" />
      </View>
    )
  }

  // Redirect to login if not authenticated
  if (!session) {
    return <Redirect href="/(auth)/login" />
  }

  // Render protected screens
  return (
    <Stack>
      <Stack.Screen
        name="index"
        options={{ title: 'Home' }}
      />
    </Stack>
  )
}

const styles = StyleSheet.create({
  loading: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
})
```

**app/(app)/index.tsx** - Home screen placeholder with logout button (AUTH-04):

```typescript
import { View, Text, TouchableOpacity, StyleSheet, Alert } from 'react-native'
import { router } from 'expo-router'
import { useAuth, signOut } from '@/features/auth'

export default function HomeScreen() {
  const { user } = useAuth()

  const handleLogout = async () => {
    try {
      await signOut()
      router.replace('/(auth)/login')
    } catch (error: any) {
      Alert.alert('Error', error.message)
    }
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Welcome!</Text>
      <Text style={styles.subtitle}>Logged in as: {user?.email}</Text>

      <View style={styles.placeholder}>
        <Text style={styles.placeholderText}>
          Your hobbies and progress will appear here in Phase 2
        </Text>
      </View>

      <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
        <Text style={styles.logoutText}>Sign Out</Text>
      </TouchableOpacity>
    </View>
  )
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 24,
    backgroundColor: '#fff',
  },
  title: {
    fontSize: 28,
    fontWeight: 'bold',
    marginTop: 48,
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 14,
    color: '#666',
    marginBottom: 32,
  },
  placeholder: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
  },
  placeholderText: {
    fontSize: 16,
    color: '#999',
    textAlign: 'center',
  },
  logoutButton: {
    padding: 16,
    alignItems: 'center',
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  logoutText: {
    color: '#FF3B30',
    fontSize: 16,
    fontWeight: '600',
  },
})
```

**app/index.tsx** - Root redirect based on auth state:

```typescript
import { Redirect } from 'expo-router'
import { View, ActivityIndicator, StyleSheet } from 'react-native'
import { useAuth } from '@/features/auth'

export default function Index() {
  const { session, loading } = useAuth()

  if (loading) {
    return (
      <View style={styles.loading}>
        <ActivityIndicator size="large" color="#007AFF" />
      </View>
    )
  }

  // Redirect based on auth state
  if (session) {
    return <Redirect href="/(app)" />
  }

  return <Redirect href="/(auth)/login" />
}

const styles = StyleSheet.create({
  loading: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
})
```
  </action>
  <verify>
    - app/(app)/_layout.tsx protects routes and redirects unauthenticated users
    - app/(app)/index.tsx shows user email and logout button
    - app/index.tsx redirects to appropriate route based on auth state
    - Logout button works and redirects to login
  </verify>
  <done>
    Protected routes implemented with auth guards, home screen with logout functionality, and root redirect logic.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete auth flow: signup, login, session persistence, logout, and protected routes.
  </what-built>
  <how-to-verify>
    Test the full auth flow:

    1. Start the app: `npx expo start`
    2. Open in Expo Go or simulator

    **Test signup (AUTH-01):**
    - Navigate to signup screen
    - Enter email and password (min 6 chars)
    - Tap "Create Account"
    - Should either redirect to home OR show "Check Your Email" if confirmation required

    **Test login (AUTH-02):**
    - If needed, go to login screen
    - Enter credentials from signup
    - Tap "Sign In"
    - Should redirect to home screen showing "Logged in as: {email}"

    **Test session persistence (AUTH-03):**
    - Close Expo Go completely (force quit)
    - Reopen and launch app
    - Should still be logged in (goes directly to home, not login)

    **Test logout (AUTH-04):**
    - On home screen, tap "Sign Out"
    - Should redirect to login screen
    - Reopen app - should stay on login (session cleared)

    **Test route protection:**
    - While logged out, try navigating to /(app) directly
    - Should redirect to login
  </how-to-verify>
  <resume-signal>Type "approved" if all auth flows work correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- [ ] Signup creates account and either logs in or shows confirmation message
- [ ] Login authenticates and redirects to protected home screen
- [ ] Home screen displays logged-in user's email
- [ ] Logout clears session and redirects to login
- [ ] Session persists across app restart
- [ ] Unauthenticated users cannot access /(app) routes
- [ ] Authenticated users are redirected away from /(auth) routes
</verification>

<success_criteria>
1. AUTH-01: User can sign up with email and password
2. AUTH-02: User can log in with existing credentials
3. AUTH-03: User session persists across app restarts
4. AUTH-04: User can log out from any screen
5. Route protection works (redirects based on auth state)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
