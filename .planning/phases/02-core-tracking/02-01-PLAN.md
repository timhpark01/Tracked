---
phase: 02-core-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/storage.ts
  - src/components/forms/ControlledInput.tsx
  - src/components/forms/ControlledTextArea.tsx
  - src/components/forms/index.ts
  - package.json
  - supabase/migrations/00002_create_storage_buckets.sql
autonomous: true

must_haves:
  truths:
    - "Image picker can be launched and returns a URI"
    - "Image can be uploaded to Supabase Storage"
    - "Storage bucket policies allow authenticated users to upload to their folder"
    - "Form components render with NativeWind styling"
  artifacts:
    - path: "src/lib/storage.ts"
      provides: "pickImage, uploadImage, uploadAvatar, uploadLogPhoto functions"
      min_lines: 50
    - path: "src/components/forms/ControlledInput.tsx"
      provides: "Reusable form input with Controller"
      min_lines: 25
    - path: "supabase/migrations/00002_create_storage_buckets.sql"
      provides: "avatars and log-photos buckets with RLS"
      contains: "storage.buckets"
  key_links:
    - from: "src/lib/storage.ts"
      to: "@supabase/supabase-js"
      via: "storage API"
      pattern: "supabase\\.storage"
    - from: "src/lib/storage.ts"
      to: "expo-file-system"
      via: "base64 conversion"
      pattern: "FileSystem\\.readAsStringAsync"
---

<objective>
Set up infrastructure for image uploads and reusable form components that all Phase 2 features will use.

Purpose: Profiles need avatar uploads, logs need photo uploads, and all features need consistent form handling. This plan creates the shared foundation.
Output: Storage utility functions, form components, and Supabase Storage buckets with proper RLS policies.
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-tracking/02-RESEARCH.md

# Phase 1 established patterns
@src/lib/supabase.ts
@src/features/auth/hooks/useAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create storage utilities</name>
  <files>
    package.json
    src/lib/storage.ts
  </files>
  <action>
1. Install required packages:
   ```bash
   npm install react-hook-form @hookform/resolvers zod base64-arraybuffer
   npx expo install expo-image-picker expo-file-system
   ```

2. Create `src/lib/storage.ts` with these exports:
   - `pickImage()`: Launch ImagePicker, request permissions, return URI or null
   - `uploadImage(bucket, path, uri)`: Convert URI to base64, then ArrayBuffer, upload to Supabase Storage, return public URL
   - `uploadAvatar(userId, uri)`: Upload to `avatars/{userId}/avatar.jpg`
   - `uploadLogPhoto(userId, logId, uri)`: Upload to `log-photos/{userId}/{logId}/{timestamp}.jpg`

Use patterns from RESEARCH.md:
- Request permissions before launching picker
- Use `quality: 0.8` for avatars, `0.7` for log photos
- Use `aspect: [1, 1]` for avatars only
- Handle cancellation gracefully (return null)

Import supabase from `@/lib/supabase`. Export all functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Imports resolve correctly in storage.ts
  </verify>
  <done>
storage.ts exports pickImage, uploadImage, uploadAvatar, uploadLogPhoto functions with proper TypeScript types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reusable form components</name>
  <files>
    src/components/forms/ControlledInput.tsx
    src/components/forms/ControlledTextArea.tsx
    src/components/forms/index.ts
  </files>
  <action>
Create reusable form components that work with react-hook-form Controller:

1. `src/components/forms/ControlledInput.tsx`:
   - Props: `control`, `name`, `label`, `placeholder`, `keyboardType`, `secureTextEntry`, `className`
   - Uses Controller from react-hook-form
   - Renders label (Text), TextInput, and error message (Text)
   - NativeWind classes: `border border-gray-300 rounded-lg px-3 py-2` for input
   - Error text: `text-red-500 text-sm mt-1`

2. `src/components/forms/ControlledTextArea.tsx`:
   - Same as ControlledInput but with `multiline`, `numberOfLines={4}`, `textAlignVertical="top"`
   - Height class: `h-24`

3. `src/components/forms/index.ts`:
   - Barrel export: `export { ControlledInput } from './ControlledInput'`
   - Barrel export: `export { ControlledTextArea } from './ControlledTextArea'`

Use generic types for form data: `<T extends FieldValues>` so components work with any form schema.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Files exist: `ls src/components/forms/`
  </verify>
  <done>
ControlledInput and ControlledTextArea components exported from src/components/forms/index.ts, ready for use in profile and hobby forms
  </done>
</task>

<task type="auto">
  <name>Task 3: Create storage bucket migration</name>
  <files>
    supabase/migrations/00002_create_storage_buckets.sql
  </files>
  <action>
Create `supabase/migrations/00002_create_storage_buckets.sql`:

```sql
-- Create avatars bucket (public read, authenticated write to own folder)
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;

-- Create log-photos bucket (public read, authenticated write to own folder)
INSERT INTO storage.buckets (id, name, public)
VALUES ('log-photos', 'log-photos', true)
ON CONFLICT (id) DO NOTHING;

-- Policy: Anyone can view avatars
CREATE POLICY "Avatars are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

-- Policy: Users can upload to their own folder
CREATE POLICY "Users can upload own avatar"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'avatars'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Policy: Users can update their own avatar
CREATE POLICY "Users can update own avatar"
ON storage.objects FOR UPDATE
TO authenticated
USING (
  bucket_id = 'avatars'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Policies for log-photos bucket
CREATE POLICY "Log photos are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'log-photos');

CREATE POLICY "Users can upload own log photos"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'log-photos'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can delete own log photos"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'log-photos'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

Note for user: After this plan completes, run `supabase db push` to apply the migration.
  </action>
  <verify>
File exists: `cat supabase/migrations/00002_create_storage_buckets.sql`
SQL syntax valid (no obvious errors)
  </verify>
  <done>
Storage migration ready to be pushed to Supabase with `supabase db push`
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-hook-form zod base64-arraybuffer expo-image-picker expo-file-system` - all installed
2. `npx tsc --noEmit` - compiles without errors
3. `ls src/lib/storage.ts src/components/forms/` - files exist
4. `cat supabase/migrations/00002_create_storage_buckets.sql` - migration exists
</verification>

<success_criteria>
- All 5 packages installed (react-hook-form, @hookform/resolvers, zod, base64-arraybuffer, expo-image-picker, expo-file-system)
- storage.ts exports 4 functions: pickImage, uploadImage, uploadAvatar, uploadLogPhoto
- ControlledInput and ControlledTextArea components exist with proper TypeScript generics
- Storage migration file exists and is ready for `supabase db push`
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-tracking/02-01-SUMMARY.md`
</output>
