---
phase: 02-core-tracking
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - src/features/logs/services/logs.service.ts
  - src/features/logs/hooks/useLogs.ts
  - src/features/logs/hooks/useCreateLog.ts
  - src/features/logs/hooks/useDeleteLog.ts
  - src/features/logs/components/LogForm.tsx
  - src/features/logs/components/LogEntry.tsx
  - src/features/logs/components/LogHistory.tsx
  - src/features/logs/index.ts
  - src/features/stats/hooks/useHobbyStats.ts
  - src/features/stats/components/ProgressBar.tsx
  - src/features/stats/index.ts
  - app/(app)/hobbies/[id]/log.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a log entry for a hobby with value and optional notes"
    - "User can attach a photo to a log entry"
    - "User can see their log history for a hobby"
    - "User can delete a log entry"
    - "User can see progress toward their goal (total, count, percentage)"
  artifacts:
    - path: "src/features/logs/services/logs.service.ts"
      provides: "CRUD functions for logs"
      min_lines: 40
    - path: "src/features/logs/hooks/useCreateLog.ts"
      provides: "Mutation hook with photo upload"
      min_lines: 40
    - path: "src/features/stats/hooks/useHobbyStats.ts"
      provides: "Stats calculation hook"
      min_lines: 25
    - path: "app/(app)/hobbies/[id]/log.tsx"
      provides: "Log entry screen"
      min_lines: 50
  key_links:
    - from: "src/features/logs/hooks/useCreateLog.ts"
      to: "src/lib/storage.ts"
      via: "photo upload"
      pattern: "uploadLogPhoto"
    - from: "src/features/stats/hooks/useHobbyStats.ts"
      to: "src/features/logs/services/logs.service.ts"
      via: "log aggregation"
      pattern: "getLogs|supabase.*hobby_logs"
---

<objective>
Build the Log and Stats features to enable progress tracking with photo attachments and goal progress visualization.

Purpose: Users need to log progress (LOG-01 through LOG-06) and see their stats (STAT-01 through STAT-03). Logs are the core action users take daily.
Output: Log service, hooks with photo upload, stats hook, and screens for logging and viewing history with progress.
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-tracking/02-RESEARCH.md

# Phase 1 patterns
@src/features/auth/hooks/useAuth.ts
@src/lib/supabase.ts
@src/types/database.ts

# Phase 2 dependencies
# @src/lib/storage.ts (from 02-01)
# @src/features/hobbies/ (from 02-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create log service and hooks</name>
  <files>
    src/features/logs/services/logs.service.ts
    src/features/logs/hooks/useLogs.ts
    src/features/logs/hooks/useCreateLog.ts
    src/features/logs/hooks/useDeleteLog.ts
    src/features/logs/index.ts
  </files>
  <action>
1. Create `src/features/logs/services/logs.service.ts`:
   ```typescript
   import { supabase } from '@/lib/supabase'
   import type { Database } from '@/types/database'

   type HobbyLog = Database['public']['Tables']['hobby_logs']['Row']
   type HobbyLogInsert = Database['public']['Tables']['hobby_logs']['Insert']

   export async function getLogs(hobbyId: string): Promise<HobbyLog[]> {
     const { data, error } = await supabase
       .from('hobby_logs')
       .select('*')
       .eq('hobby_id', hobbyId)
       .order('logged_at', { ascending: false })

     if (error) throw error
     return data
   }

   export async function createLog(log: HobbyLogInsert): Promise<HobbyLog> {
     const { data, error } = await supabase
       .from('hobby_logs')
       .insert(log)
       .select()
       .single()

     if (error) throw error
     return data
   }

   export async function deleteLog(logId: string): Promise<void> {
     const { error } = await supabase
       .from('hobby_logs')
       .delete()
       .eq('id', logId)

     if (error) throw error
   }
   ```

2. Create `src/features/logs/hooks/useLogs.ts`:
   - Accept `hobbyId: string`
   - Query key: `['logs', hobbyId]`
   - Fetch using `getLogs(hobbyId)`
   - `enabled: !!hobbyId`

3. Create `src/features/logs/hooks/useCreateLog.ts`:
   ```typescript
   import { useMutation, useQueryClient } from '@tanstack/react-query'
   import { createLog } from '../services/logs.service'
   import { uploadLogPhoto } from '@/lib/storage'
   import { useAuth } from '@/features/auth'

   interface CreateLogInput {
     hobbyId: string
     value: number
     note?: string
     photoUri?: string
   }

   export function useCreateLog() {
     const { user } = useAuth()
     const queryClient = useQueryClient()

     return useMutation({
       mutationFn: async (input: CreateLogInput) => {
         let image_urls: string[] | undefined

         // Upload photo if provided
         if (input.photoUri && user) {
           const tempId = `${Date.now()}`
           const url = await uploadLogPhoto(user.id, tempId, input.photoUri)
           image_urls = [url]
         }

         return createLog({
           hobby_id: input.hobbyId,
           user_id: user!.id,
           value: input.value,
           note: input.note,
           image_urls,
         })
       },
       onSuccess: (_data, variables) => {
         queryClient.invalidateQueries({ queryKey: ['logs', variables.hobbyId] })
         queryClient.invalidateQueries({ queryKey: ['hobby-stats', variables.hobbyId] })
       },
     })
   }
   ```

4. Create `src/features/logs/hooks/useDeleteLog.ts`:
   - Accept `{ logId, hobbyId }` to know which queries to invalidate
   - Invalidate logs and stats on success

5. Create `src/features/logs/index.ts`:
   ```typescript
   export { useLogs } from './hooks/useLogs'
   export { useCreateLog } from './hooks/useCreateLog'
   export { useDeleteLog } from './hooks/useDeleteLog'
   export * from './services/logs.service'
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Service exports: `grep "export async function" src/features/logs/services/logs.service.ts`
  </verify>
  <done>
Log service with getLogs, createLog, deleteLog. Hooks useLogs, useCreateLog (with photo upload), useDeleteLog ready.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stats hook and progress components</name>
  <files>
    src/features/stats/hooks/useHobbyStats.ts
    src/features/stats/components/ProgressBar.tsx
    src/features/stats/index.ts
  </files>
  <action>
1. Create `src/features/stats/hooks/useHobbyStats.ts`:
   ```typescript
   import { useQuery } from '@tanstack/react-query'
   import { supabase } from '@/lib/supabase'

   interface HobbyStats {
     totalValue: number
     logCount: number
     goalTotal: number | null
     progressPercent: number
     goalUnit: string | null
   }

   async function getHobbyStats(hobbyId: string): Promise<HobbyStats> {
     // Get hobby for goal info
     const { data: hobby } = await supabase
       .from('hobbies')
       .select('goal_total, goal_unit, tracking_type')
       .eq('id', hobbyId)
       .single()

     // Get logs with count
     const { data: logs, count } = await supabase
       .from('hobby_logs')
       .select('value', { count: 'exact' })
       .eq('hobby_id', hobbyId)

     const totalValue = logs?.reduce((sum, log) => sum + log.value, 0) ?? 0
     const goalTotal = hobby?.goal_total ?? null
     const progressPercent = goalTotal
       ? Math.min(100, Math.round((totalValue / goalTotal) * 100))
       : 0

     return {
       totalValue,
       logCount: count ?? 0,
       goalTotal,
       progressPercent,
       goalUnit: hobby?.goal_unit ?? (hobby?.tracking_type === 'time' ? 'minutes' : null),
     }
   }

   export function useHobbyStats(hobbyId: string) {
     return useQuery({
       queryKey: ['hobby-stats', hobbyId],
       queryFn: () => getHobbyStats(hobbyId),
       enabled: !!hobbyId,
     })
   }
   ```

2. Create `src/features/stats/components/ProgressBar.tsx`:
   ```typescript
   import { View, Text } from 'react-native'

   interface ProgressBarProps {
     progress: number  // 0-100
     total: number
     current: number
     unit?: string
     className?: string
   }

   export function ProgressBar({ progress, total, current, unit, className }: ProgressBarProps) {
     const clampedProgress = Math.min(100, Math.max(0, progress))

     return (
       <View className={className}>
         <View className="flex-row justify-between mb-1">
           <Text className="text-sm text-gray-600">
             {current} / {total} {unit}
           </Text>
           <Text className="text-sm font-medium">
             {clampedProgress}%
           </Text>
         </View>
         <View className="h-2 bg-gray-200 rounded-full overflow-hidden">
           <View
             className="h-full bg-blue-500 rounded-full"
             style={{ width: `${clampedProgress}%` }}
           />
         </View>
       </View>
     )
   }
   ```

3. Create `src/features/stats/index.ts`:
   ```typescript
   export { useHobbyStats } from './hooks/useHobbyStats'
   export { ProgressBar } from './components/ProgressBar'
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Files exist: `ls src/features/stats/`
  </verify>
  <done>
useHobbyStats returns totalValue, logCount, goalTotal, progressPercent. ProgressBar component displays visual progress.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create log UI components and screens</name>
  <files>
    src/features/logs/components/LogForm.tsx
    src/features/logs/components/LogEntry.tsx
    src/features/logs/components/LogHistory.tsx
    app/(app)/hobbies/[id]/log.tsx
    app/(app)/hobbies/[id].tsx
  </files>
  <action>
1. Create `src/features/logs/components/LogForm.tsx`:
   - Props: `trackingType: 'time' | 'quantity'`, `goalUnit?: string`, `onSubmit`, `isLoading`
   - Zod schema: `value` (positive number), `note` (optional, max 1000)
   - State for `photoUri`
   - Photo picker button (uses `pickImage()`)
   - Show photo preview if selected
   - Dynamic label: "Minutes" for time, goal_unit or "Units" for quantity
   - Submit button with loading state

2. Create `src/features/logs/components/LogEntry.tsx`:
   - Props: `log: HobbyLog`, `unit?: string`, `onDelete?: () => void`
   - Display: value with unit, note (truncated), photo thumbnail if exists, date
   - Delete button (optional, shows confirmation)
   - NativeWind: card styling

3. Create `src/features/logs/components/LogHistory.tsx`:
   - Props: `logs: HobbyLog[]`, `unit?: string`, `onDeleteLog: (id) => void`
   - FlatList of LogEntry components
   - Empty state: "No logs yet. Start tracking your progress!"

4. Create `app/(app)/hobbies/[id]/log.tsx`:
   - Use `useLocalSearchParams()` to get hobby `id`
   - Use `useHobby(id)` to get tracking_type and goal_unit
   - Use `useCreateLog()` for mutation
   - Show `LogForm` with hobby's tracking type
   - On submit: create log with photo, navigate back to hobby detail
   - Handle errors with alert

5. Update `app/(app)/hobbies/[id].tsx` to include:
   - Import and use `useHobbyStats(id)`
   - Import `ProgressBar` and `LogHistory` components
   - Import `useLogs(id)` and `useDeleteLog()`
   - Show `ProgressBar` if goal is set (using stats data)
   - Show stats summary: "X logs, Y total minutes/units"
   - Show `LogHistory` with delete functionality
   - "Log Progress" button navigates to `/hobbies/[id]/log`
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
All files exist: `ls app/\(app\)/hobbies/\[id\]/`
  </verify>
  <done>
Full log flow: hobby detail shows stats and history, log button opens form, photo can be attached, new logs appear in history with updated stats.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - compiles without errors
2. `ls src/features/logs/ src/features/stats/` - all directories exist
3. `ls app/\(app\)/hobbies/\[id\]/` - log.tsx exists
4. Manually test: Create hobby with goal -> Log progress -> See stats update -> Delete log -> Stats update
</verification>

<success_criteria>
- Log service with getLogs, createLog, deleteLog
- useCreateLog handles photo upload before creating log
- useHobbyStats calculates total, count, and percentage
- LogForm validates input and shows photo picker
- Hobby detail screen shows progress bar (if goal set), stats, and log history
- Deleting a log updates both logs list and stats
- Photos can be attached to logs and display in history
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-tracking/02-04-SUMMARY.md`
</output>
