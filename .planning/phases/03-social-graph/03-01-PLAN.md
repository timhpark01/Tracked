---
phase: 03-social-graph
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/social/services/social.service.ts
  - src/features/social/hooks/useFollowUser.ts
  - src/features/social/hooks/useUnfollowUser.ts
  - src/features/social/hooks/useFollowers.ts
  - src/features/social/hooks/useFollowing.ts
  - src/features/social/hooks/useIsFollowing.ts
  - src/features/social/hooks/useSearchUsers.ts
  - src/features/social/index.ts
autonomous: true

must_haves:
  truths:
    - "Service functions can follow/unfollow users in database"
    - "Service functions can query followers/following lists"
    - "Service functions can search users by username prefix"
    - "Hooks provide optimistic updates for follow/unfollow"
    - "Hooks properly invalidate related queries after mutations"
  artifacts:
    - path: "src/features/social/services/social.service.ts"
      provides: "Database CRUD operations for follows"
      exports: ["followUser", "unfollowUser", "getFollowers", "getFollowing", "checkIsFollowing", "searchUsers"]
    - path: "src/features/social/hooks/useFollowUser.ts"
      provides: "Follow mutation with optimistic update"
      exports: ["useFollowUser"]
    - path: "src/features/social/hooks/useUnfollowUser.ts"
      provides: "Unfollow mutation with optimistic update"
      exports: ["useUnfollowUser"]
    - path: "src/features/social/hooks/useFollowers.ts"
      provides: "Query for followers list"
      exports: ["useFollowers"]
    - path: "src/features/social/hooks/useFollowing.ts"
      provides: "Query for following list"
      exports: ["useFollowing"]
    - path: "src/features/social/hooks/useIsFollowing.ts"
      provides: "Query to check follow status"
      exports: ["useIsFollowing"]
    - path: "src/features/social/hooks/useSearchUsers.ts"
      provides: "Query for user search"
      exports: ["useSearchUsers"]
    - path: "src/features/social/index.ts"
      provides: "Public exports for social feature"
      min_lines: 10
  key_links:
    - from: "src/features/social/hooks/useFollowUser.ts"
      to: "src/features/social/services/social.service.ts"
      via: "import followUser"
      pattern: "import.*followUser.*from.*social.service"
    - from: "src/features/social/hooks/useFollowUser.ts"
      to: "queryClient.invalidateQueries"
      via: "onSettled invalidation"
      pattern: "invalidateQueries.*followers|following|isFollowing"
---

<objective>
Create the social feature module with service layer and TanStack Query hooks for follow/unfollow functionality and user search.

Purpose: Provides the data layer foundation for the social graph, enabling follow relationships and user discovery with optimistic updates.

Output: Complete `src/features/social/` module with service and 6 hooks ready for UI consumption.
</objective>

<execution_context>
@/Users/tim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-social-graph/03-RESEARCH.md

# Existing patterns to follow
@src/features/profiles/services/profiles.service.ts
@src/features/hobbies/hooks/useCreateHobby.ts
@src/features/hobbies/hooks/useDeleteHobby.ts
@src/features/profiles/hooks/useProfile.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create social service layer</name>
  <files>src/features/social/services/social.service.ts</files>
  <action>
Create the social service with these functions following existing patterns from profiles.service.ts:

1. **followUser(followerId: string, followingId: string)**: Insert into follows table, return Follow row. Use `.select().single()` pattern.

2. **unfollowUser(followerId: string, followingId: string)**: Delete from follows where follower_id and following_id match. Return void.

3. **getFollowers(userId: string)**: Query follows table with joined profile data using:
   `.select('follower:profiles!follows_follower_id_fkey(*)')`
   Return Profile[] (extract from nested structure).
   Order by created_at descending. Limit to 50.

4. **getFollowing(userId: string)**: Query follows table with joined profile data using:
   `.select('following:profiles!follows_following_id_fkey(*)')`
   Return Profile[] (extract from nested structure).
   Order by created_at descending. Limit to 50.

5. **checkIsFollowing(followerId: string, followingId: string)**: Query follows for matching row using `.maybeSingle()`. Return boolean (data !== null).

6. **searchUsers(query: string, currentUserId: string, limit = 20)**:
   - Return empty array if query.length < 2
   - Use `.ilike('username', `${query}%`)` for prefix match
   - Exclude currentUserId with `.neq('id', currentUserId)`
   - Order by username, limit results

Export types: Follow, Profile from Database types.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd /Users/tim/Documents/GitHub/Tracked && npx tsc --noEmit
```
  </verify>
  <done>
Service file exists with all 6 functions exported, TypeScript types are correct, no compilation errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create query hooks</name>
  <files>
src/features/social/hooks/useFollowers.ts
src/features/social/hooks/useFollowing.ts
src/features/social/hooks/useIsFollowing.ts
src/features/social/hooks/useSearchUsers.ts
  </files>
  <action>
Create 4 query hooks following patterns from useProfile.ts:

**useFollowers(userId: string)**
- queryKey: ['followers', userId]
- queryFn: () => getFollowers(userId)
- enabled: !!userId
- staleTime: 5 * 60 * 1000 (5 min)
- gcTime: 24 * 60 * 60 * 1000 (24 hours)

**useFollowing(userId: string)**
- queryKey: ['following', userId]
- queryFn: () => getFollowing(userId)
- enabled: !!userId
- staleTime: 5 * 60 * 1000
- gcTime: 24 * 60 * 60 * 1000

**useIsFollowing(targetUserId: string)**
- Get current user from useAuth()
- queryKey: ['isFollowing', user?.id, targetUserId]
- queryFn: () => checkIsFollowing(user!.id, targetUserId)
- enabled: !!user && !!targetUserId && user.id !== targetUserId
- staleTime: 5 * 60 * 1000
- Returns boolean

**useSearchUsers(query: string)**
- Get current user from useAuth()
- queryKey: ['searchUsers', query]
- queryFn: () => searchUsers(query, user!.id)
- enabled: !!user && query.length >= 2
- staleTime: 30 * 1000 (30 sec - search results can change)
- gcTime: 5 * 60 * 1000 (5 min)

Import useQuery from @tanstack/react-query.
Import useAuth from @/features/auth.
Import service functions from ../services/social.service.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd /Users/tim/Documents/GitHub/Tracked && npx tsc --noEmit
```
  </verify>
  <done>
4 query hooks exist, each returns useQuery result with proper typing, enabled guards prevent unnecessary queries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create mutation hooks with optimistic updates</name>
  <files>
src/features/social/hooks/useFollowUser.ts
src/features/social/hooks/useUnfollowUser.ts
src/features/social/index.ts
  </files>
  <action>
Create 2 mutation hooks following patterns from useCreateHobby.ts and useDeleteHobby.ts:

**useFollowUser()**
- Get user from useAuth(), queryClient from useQueryClient()
- mutationFn: ({ followingId }: { followingId: string }) => followUser(user!.id, followingId)
- onMutate:
  - Cancel queries: ['following', user?.id], ['isFollowing', user?.id, followingId]
  - Snapshot previousFollowing and previousIsFollowing
  - Optimistically set isFollowing to true: queryClient.setQueryData(['isFollowing', user?.id, followingId], true)
  - Return context with snapshots
- onError: Rollback both snapshots
- onSettled: Invalidate ALL related queries:
  - ['following', user?.id]
  - ['followers', followingId]
  - ['isFollowing', user?.id, followingId]
  - ['profile', followingId] (for follower count if displayed)

**useUnfollowUser()**
- Same pattern as useFollowUser but:
  - mutationFn calls unfollowUser
  - Optimistically set isFollowing to false
  - Same invalidation pattern in onSettled

**index.ts** - Create barrel export:
```typescript
// Services
export * from './services/social.service'

// Hooks
export { useFollowUser } from './hooks/useFollowUser'
export { useUnfollowUser } from './hooks/useUnfollowUser'
export { useFollowers } from './hooks/useFollowers'
export { useFollowing } from './hooks/useFollowing'
export { useIsFollowing } from './hooks/useIsFollowing'
export { useSearchUsers } from './hooks/useSearchUsers'
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd /Users/tim/Documents/GitHub/Tracked && npx tsc --noEmit
```

Verify exports work:
```bash
cd /Users/tim/Documents/GitHub/Tracked && grep -c "export" src/features/social/index.ts
```
Should return 7+ (services + 6 hooks).
  </verify>
  <done>
Both mutation hooks exist with optimistic updates and proper cache invalidation. Index.ts exports all hooks and service functions. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Directory structure:**
```bash
ls -la src/features/social/
ls -la src/features/social/services/
ls -la src/features/social/hooks/
```
Should show service.ts, 6 hook files, and index.ts.

2. **TypeScript compilation:**
```bash
npx tsc --noEmit
```
No errors.

3. **Export verification:**
```bash
grep "export" src/features/social/index.ts
```
All 6 hooks and service exports present.
</verification>

<success_criteria>
- src/features/social/ directory created with proper structure
- social.service.ts exports 6 functions (followUser, unfollowUser, getFollowers, getFollowing, checkIsFollowing, searchUsers)
- 6 hooks created (useFollowUser, useUnfollowUser, useFollowers, useFollowing, useIsFollowing, useSearchUsers)
- Mutation hooks include optimistic updates and invalidate all related queries
- Query hooks have proper enabled guards
- index.ts exports all public APIs
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-social-graph/03-01-SUMMARY.md`
</output>
